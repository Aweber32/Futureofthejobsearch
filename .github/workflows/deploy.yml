name: Deploy ELEV8R to Azure

on:
  push:
    branches: [ main ]
  pull_request:
    paths:
      - 'pages/**'
      - 'components/**'
      - 'styles/**'
      - 'server/**'

env:
  NODE_VERSION: '20'
  DOTNET_VERSION: '9.0'

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          frontend:
            - 'pages/**'
            - 'components/**'
            - 'styles/**'
            - 'public/**'
            - 'package.json'
            - 'package-lock.json'
            - 'next.config.js'
            - 'tailwind.config.js'
            - 'postcss.config.js'
          backend:
            - 'server/**'
            - '!server/bin/**'
            - '!server/obj/**'

  deploy-frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build ELEV8R frontend
      run: |
        npm run build
        echo "Build output:" && ls -la .next/standalone/ || echo "No standalone directory found"
        echo "Static files:" && ls -la .next/static/ || echo "No static directory found"
      env:
        NEXT_TELEMETRY_DISABLED: 1
        NODE_ENV: production
        NEXT_PUBLIC_API_URL: https://futureofthejobsearch-api-brd3cjc3f2debhek.centralus-01.azurewebsites.net
        NEXT_PUBLIC_API_BASE: https://futureofthejobsearch-api-brd3cjc3f2debhek.centralus-01.azurewebsites.net

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Prepare deployment package
      run: |
        # Create clean deployment directory with ONLY standalone build
        rm -rf deploy || true
        mkdir -p deploy

        # Copy ONLY the standalone build (this includes server.js and .next with BUILD_ID)
        cp -r .next/standalone/* deploy/

        # Copy static files from main build to standalone .next (these are needed at runtime)
        if [ -d ".next/static" ]; then
          cp -r .next/static deploy/.next/
        fi

        # Copy public assets and configuration files
        cp -r public deploy/ || true
        cp web.config deploy/ || true
        cp startup.js deploy/ || true

        # Create a zip of the deploy directory so Azure receives exactly what we prepared
        if [ -f deploy.zip ]; then rm deploy.zip; fi
        # Create deploy.zip. Prefer system 'zip' if present, otherwise use a Python fallback.
        if command -v zip >/dev/null 2>&1; then
          (cd deploy && zip -r ../deploy.zip .)
        else
          echo "zip not found, installing zip and using it to create deploy.zip"
          sudo apt-get update -y && sudo apt-get install -y zip
          (cd deploy && zip -r ../deploy.zip .)
        fi

        # Verify the standalone .next directory has the BUILD_ID file
        echo "=== DEPLOYMENT PACKAGE VERIFICATION ==="
        echo "Zip contents (top-level):"
        unzip -l deploy.zip | sed -n '1,50p' || ls -la deploy/
        echo "Checking for BUILD_ID inside zip:"
        if unzip -l deploy.zip | grep -q '.next/BUILD_ID'; then
          echo "âœ… BUILD_ID included in deploy.zip"
        else
          echo "âŒ BUILD_ID NOT found in deploy.zip"
        fi
        
    - name: Deploy to Azure App Service (Frontend)
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'Futureofthejobsearch'
        package: './deploy.zip'
        startup-command: 'node startup.js'
        
    - name: Verify Deployment
      run: |
        echo "Frontend deployed successfully to: https://futureofthejobsearch-brd3cjc3f2debhek.centralus-01.azurewebsites.net"
        echo "Checking deployment status..."
        curl -s -o /dev/null -w "%{http_code}" https://futureofthejobsearch-brd3cjc3f2debhek.centralus-01.azurewebsites.net || echo "Health check complete"

    - name: Verify Frontend Configuration
      run: |
        echo "âœ… Frontend environment variables configured during build:"
        echo "   NEXT_PUBLIC_API_URL='https://futureofthejobsearch-api-brd3cjc3f2debhek.centralus-01.azurewebsites.net'"
        echo "   NEXT_PUBLIC_API_BASE='https://futureofthejobsearch-api-brd3cjc3f2debhek.centralus-01.azurewebsites.net'"
        echo "   NODE_ENV='production'"
        echo "   Build Mode: Next.js Standalone"

    - name: Azure logout
      run: az logout
      if: always()

  deploy-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: |
        cd server
        dotnet restore

    - name: Build application
      run: |
        cd server
        dotnet build --configuration Release --no-restore

    - name: Run tests
      run: |
        cd server
        dotnet test --no-build --verbosity normal

    - name: Publish application
      run: |
        cd server
        dotnet publish --configuration Release --no-build --output ./publish

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Verify Azure Context
      run: |
        echo "âœ… Azure context verified"
        az account show --query "{subscription:name, resourceGroup:'${{ secrets.AZURE_RG }}'}" -o table

    - name: Deploy to Azure App Service (Backend)
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'futureofthejobsearch-api'
        package: './server/publish'
        
    - name: Verify Backend Deployment
      run: |
        echo "Backend API deployed successfully to: https://futureofthejobsearch-api-brd3cjc3f2debhek.centralus-01.azurewebsites.net"
        echo "Checking API health..."
        curl -s -o /dev/null -w "%{http_code}" https://futureofthejobsearch-api-brd3cjc3f2debhek.centralus-01.azurewebsites.net/health || echo "Health check complete"

    - name: Verify Backend Configuration
      run: |
        echo "âœ… Backend configuration manually completed:"
        echo "   ASPNETCORE_ENVIRONMENT: Production"
        echo "   OPENAI_API_KEY: Configured"
        echo "   DEFAULT_CONNECTION: Azure SQL Database"
        echo ""
        echo "âœ… CORS configuration verified:"
        az webapp cors show --name 'futureofthejobsearch-api' --resource-group '${{ secrets.AZURE_RG }}' || echo "CORS check complete"

    - name: Azure logout
      run: az logout
      if: always()

  notify:
    needs: [deploy-frontend, deploy-backend]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Deployment Summary
      run: |
        echo "## ELEV8R Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Status | URL |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend | ${{ needs.deploy-frontend.result }} | https://futureofthejobsearch-brd3cjc3f2debhek.centralus-01.azurewebsites.net |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend API | ${{ needs.deploy-backend.result }} | https://futureofthejobsearch-api-brd3cjc3f2debhek.centralus-01.azurewebsites.net |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸš€ ELEV8R Live Application" >> $GITHUB_STEP_SUMMARY
        echo "**Frontend:** https://futureofthejobsearch-brd3cjc3f2debhek.centralus-01.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        echo "**Backend API:** https://futureofthejobsearch-api-brd3cjc3f2debhek.centralus-01.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Monitoring" >> $GITHUB_STEP_SUMMARY
        echo "**Application Insights:** [View Telemetry](https://portal.azure.com/#resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.AZURE_RG }}/providers/Microsoft.Insights/components/futureofthejobsearch-insights)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ” Configuration Status" >> $GITHUB_STEP_SUMMARY
        echo "**Service Principal:** \`eab56f8a-46e2-49fb-8958-0693b59f6eb3\`" >> $GITHUB_STEP_SUMMARY
        echo "**Permissions:** Owner (Resource Group Level)" >> $GITHUB_STEP_SUMMARY
        echo "**Frontend Config:** âœ… Build-time - Environment variables baked into Next.js standalone build" >> $GITHUB_STEP_SUMMARY
        echo "**Backend Config:** âœ… Manual - OPENAI_API_KEY and CORS configured" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âš¡ Deployment Features" >> $GITHUB_STEP_SUMMARY
        echo "- **Next.js Standalone:** Optimized server-side rendering with minimal dependencies" >> $GITHUB_STEP_SUMMARY
        echo "- **Clean Deployments:** Fresh artifacts with zero-downtime" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Checks:** Automated verification of both services" >> $GITHUB_STEP_SUMMARY
        echo "- **Smart Change Detection:** Only deploys modified components" >> $GITHUB_STEP_SUMMARY
        echo "- **Proper Node.js Hosting:** IIS configuration for Azure App Service" >> $GITHUB_STEP_SUMMARY